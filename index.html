<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Jemaat GSRI Singkawang</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .header-section {
            background: linear-gradient(135deg, #0d6efd, #6f42c1);
            color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .header-section h1 {
            font-size: 2.2rem;
        }
        .header-section .lead {
            font-size: 0.9rem;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            border: none;
        }
        .btn-icon {
            margin-right: 0.5rem;
        }
        .table-responsive {
            max-height: 80vh; 
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #e9ecef;
        }
        .table th:nth-child(4), .table td:nth-child(4) { min-width: 125px; }
        .table th:nth-child(3), .table td:nth-child(3),
        .table th:nth-child(7), .table td:nth-child(7) { min-width: 110px; }
        .table th:nth-child(9), .table td:nth-child(9) { min-width: 300px; }
        #clearSearchBtn, #clearSearchBtnGuest {
            border: none; background: none; color: #6c757d; cursor: pointer;
        }
        #clearSearchBtn:hover, #clearSearchBtnGuest:hover { color: #212529; }
    </style>
</head>
<body>
    <!-- Kontainer Halaman Login -->
    <div id="login-page" class="container my-4">
        <header class="header-section">
            <h1 class="display-5 fw-bold">DATA JEMAAT GSRI SINGKAWANG</h1>
            <p class="lead mb-0">Powered by Tim MediaTech GSRI Skw</p>
            <span class="badge bg-light text-dark mt-2" id="appVersionLogin"></span>
        </header>
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="loginTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin-login-pane" type="button" role="tab" aria-controls="admin-login-pane" aria-selected="true">Login Admin</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="guest-tab" data-bs-toggle="tab" data-bs-target="#guest-login-pane" type="button" role="tab" aria-controls="guest-login-pane" aria-selected="false">Login Tamu</button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-4">
                        <div class="tab-content" id="loginTabContent">
                            <!-- Form Login Admin -->
                            <div class="tab-pane fade show active" id="admin-login-pane" role="tabpanel" aria-labelledby="admin-tab" tabindex="0">
                                <form id="login-form">
                                    <div class="mb-3">
                                        <label for="loginEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="loginEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="loginPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="loginPassword" required>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">Login</button>
                                    </div>
                                </form>
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                                        Lupa Password?
                                    </button>
                                </div>
                            </div>
                            <!-- Form Login Tamu -->
                            <div class="tab-pane fade" id="guest-login-pane" role="tabpanel" aria-labelledby="guest-tab" tabindex="0">
                                <form id="guest-login-form">
                                    <div class="mb-3">
                                        <label for="guestPin" class="form-label">PIN Tamu (6 Angka)</label>
                                        <input type="password" class="form-control" id="guestPin" maxlength="6" inputmode="numeric" required>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-secondary">Login sebagai Tamu</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kontainer Aplikasi Admin -->
    <div id="main-app-admin" class="container my-4" style="display: none;">
        <header class="header-section">
            <h1 class="display-5 fw-bold">DATA JEMAAT GSRI SINGKAWANG</h1>
            <div class="d-flex justify-content-center align-items-center gap-3">
                <p class="lead mb-0">Powered by Tim MediaTech GSRI Skw</p>
                <button class="btn btn-sm btn-outline-light" id="logout-btn-admin">Logout</button>
            </div>
            <span class="badge bg-light text-dark mt-2" id="appVersionMain"></span>
        </header>
        <main>
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0" id="formTitle"><i class="bi bi-person-plus-fill btn-icon"></i>Tambah Data Jemaat</h5>
                </div>
                <div class="card-body">
                    <form id="formJemaat">
                        <fieldset id="formFieldset">
                            <input type="hidden" id="editId">
                            <div class="row">
                                <div class="col-md-4 mb-3"><label for="noJemaat" class="form-label">No Jemaat</label><input type="number" class="form-control" id="noJemaat"></div>
                                <div class="col-md-4 mb-3"><label for="noBaptis" class="form-label">No Baptis</label><input type="text" class="form-control" id="noBaptis"></div>
                                <div class="col-md-4 mb-3"><label for="tglBaptis" class="form-label">Tanggal Baptis</label><input type="date" class="form-control" id="tglBaptis"></div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-8"><label for="nama" class="form-label">Nama</label><input type="text" class="form-control" id="nama" oninput="this.value = this.value.toUpperCase()"></div>
                                <div class="col-md-4"><label class="form-label">Jenis Kelamin</label><div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="jenisKelamin" id="kelaminPria" value="Pria" checked><label class="form-check-label" for="kelaminPria">Pria</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="jenisKelamin" id="kelaminWanita" value="Wanita"><label class="form-check-label" for="kelaminWanita">Wanita</label></div></div></div>
                            </div>
                            <div class="row">
                                 <div class="col-md-8 mb-3"><label for="tempatLahir" class="form-label">Tempat Lahir</label><input type="text" class="form-control" id="tempatLahir"></div>
                                <div class="col-md-4 mb-3"><label for="tglLahir" class="form-label">Tanggal Lahir</label><input type="date" class="form-control" id="tglLahir"></div>
                            </div>
                            <div class="mb-3"><label for="noTelepon" class="form-label">No Telepon / WhatsApp</label><input type="tel" class="form-control" id="noTelepon"></div>
                            <div class="mb-3"><label for="alamat" class="form-label">Alamat Lengkap</label><textarea class="form-control" id="alamat" rows="3"></textarea></div>
                            <div class="mb-3"><label for="statusJemaat" class="form-label">Status Jemaat</label><select class="form-select" id="statusJemaat"><option value="Aktif" selected>Aktif</option><option value="Tidak Aktif">Tidak Aktif</option><option value="Pindah">Pindah</option><option value="Meninggal">Meninggal</option></select></div>
                        </fieldset>
                        <div class="d-flex justify-content-end gap-2" id="formButtons"></div>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-wrap justify-content-between align-items-center"><h5 class="mb-0">Daftar Jemaat (<span id="jumlahData">0</span>)</h5><small class="text-muted" id="updateTerakhir">Update data terakhir: -</small></div>
                    <div class="mt-2 position-relative"><input type="text" id="cariData" class="form-control" placeholder="Cari data berdasarkan No, Nama, Tahun Lahir/Baptis, dll..."><button id="clearSearchBtn" class="position-absolute top-50 end-0 translate-middle-y me-2" style="display: none;"><i class="bi bi-x-lg"></i></button></div>
                </div>
                <div class="card-body p-0"><div class="table-responsive"><table class="table table-striped table-hover mb-0"><thead><tr><th scope="col">No Jemaat</th><th scope="col">No Baptis</th><th scope="col">Tgl Baptis</th><th scope="col">Nama</th><th scope="col">Jenis Kelamin</th><th scope="col">Tempat Lahir</th><th scope="col">Tgl Lahir</th><th scope="col">No. Telepon</th><th scope="col">Alamat</th><th scope="col">Status</th><th scope="col">Aksi</th></tr></thead><tbody id="tabelJemaat"></tbody></table></div></div>
                <div class="card-footer d-flex flex-wrap gap-2 justify-content-end"><button class="btn btn-success btn-sm" id="btnImport"><i class="bi bi-file-earmark-arrow-up btn-icon"></i>Import File</button><button class="btn btn-primary btn-sm" id="btnExport"><i class="bi bi-file-earmark-arrow-down btn-icon"></i>Export File</button><button class="btn btn-danger btn-sm" id="btnHapusSemua" data-bs-toggle="modal" data-bs-target="#hapusSemuaModal"><i class="bi bi-trash3 btn-icon"></i>Hapus Tabel</button></div>
            </div>
        </main>
    </div>

    <!-- Kontainer Aplikasi Tamu -->
    <div id="main-app-guest" class="container my-4" style="display: none;">
        <header class="header-section">
            <h1 class="display-5 fw-bold">DATA JEMAAT GSRI SINGKAWANG</h1>
            <div class="d-flex justify-content-center align-items-center gap-3">
                <p class="lead mb-0">Powered by Tim MediaTech GSRI Skw</p>
                <button class="btn btn-sm btn-outline-light" id="logout-btn-guest">Logout</button>
            </div>
            <span class="badge bg-light text-dark mt-2" id="appVersionGuest"></span>
        </header>
        <main>
             <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-wrap justify-content-between align-items-center">
                        <h5 class="mb-0">Daftar Jemaat (<span id="jumlahDataGuest">0</span>)</h5>
                        <small class="text-muted" id="updateTerakhirGuest">Update data terakhir: -</small>
                    </div>
                    <div class="mt-2 position-relative">
                        <input type="text" id="cariDataGuest" class="form-control" placeholder="Cari data berdasarkan No, Nama, Tahun Lahir/Baptis, dll...">
                        <button id="clearSearchBtnGuest" class="position-absolute top-50 end-0 translate-middle-y me-2" style="display: none;"><i class="bi bi-x-lg"></i></button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">No Jemaat</th>
                                    <th scope="col">No Baptis</th>
                                    <th scope="col">Tgl Baptis</th>
                                    <th scope="col">Nama</th>
                                    <th scope="col">Jenis Kelamin</th>
                                    <th scope="col">Tempat Lahir</th>
                                    <th scope="col">Tgl Lahir</th>
                                    <th scope="col">No. Telepon</th>
                                    <th scope="col">Alamat</th>
                                    <th scope="col">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tabelJemaatGuest">
                                <tr><td colspan="10" class="text-center">Memuat data dari database...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFileInput" accept=".tsv" style="display: none;">
    <!-- Modals -->
    <div class="modal fade" id="notificationModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h1 class="modal-title fs-5" id="notificationModalLabel">Notifikasi</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="notificationModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button></div></div></div></div>
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h1 class="modal-title fs-5" id="forgotPasswordModalLabel">Reset Password</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>Masukkan email Anda untuk menerima link reset password.</p><input type="email" class="form-control" id="resetEmailInput" placeholder="Email terdaftar"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-primary" id="sendResetEmailBtn">Kirim</button></div></div></div></div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h1 class="modal-title fs-5" id="confirmDeleteModalLabel">Konfirmasi Hapus</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Apakah Anda yakin ingin menghapus data ini?</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-danger" id="btnKonfirmasiHapusBaris">Ya, Hapus</button></div></div></div></div>
    <div class="modal fade" id="hapusSemuaModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h1 class="modal-title fs-5" id="hapusSemuaModalLabel">Konfirmasi Hapus Semua Data</h1><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">Apakah Anda yakin ingin menghapus SEMUA data jemaat? Tindakan ini tidak dapat dibatalkan.</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="button" class="btn btn-danger" id="btnKonfirmasiHapusSemua">Ya, Hapus Semua</button></div></div></div></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, setPersistence, browserSessionPersistence, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, serverTimestamp, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDST2tE8X4pKUdg114xgG2QLW7-1RJXwLw",
            authDomain: "data-jemaat-gsri-skw.firebaseapp.com",
            projectId: "data-jemaat-gsri-skw",
            storageBucket: "data-jemaat-gsri-skw.appspot.com",
            messagingSenderId: "960533820471",
            appId: "1:960533820471:web:fe86a8921dcb7ae632fbb2",
            measurementId: "G-VXHNCYRM13"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const jemaatCollectionRef = collection(db, "jemaat");

        // --- VARIABEL GLOBAL & REFERENSI DOM ---
        const loginPage = document.getElementById('login-page');
        const mainAppAdmin = document.getElementById('main-app-admin');
        const mainAppGuest = document.getElementById('main-app-guest');
        
        const loginForm = document.getElementById('login-form');
        const guestLoginForm = document.getElementById('guest-login-form');
        const logoutBtnAdmin = document.getElementById('logout-btn-admin');
        const logoutBtnGuest = document.getElementById('logout-btn-guest');
        const sendResetEmailBtn = document.getElementById('sendResetEmailBtn');

        const formJemaat = document.getElementById('formJemaat');
        const formTitle = document.getElementById('formTitle');
        const formFieldset = document.getElementById('formFieldset');
        const formButtons = document.getElementById('formButtons');
        
        const editIdInput = document.getElementById('editId');
        const noJemaatInput = document.getElementById('noJemaat');
        const noBaptisInput = document.getElementById('noBaptis');
        const namaInput = document.getElementById('nama');
        const tempatLahirInput = document.getElementById('tempatLahir');
        const tglLahirInput = document.getElementById('tglLahir');
        const tglBaptisInput = document.getElementById('tglBaptis');
        const noTeleponInput = document.getElementById('noTelepon');
        const alamatInput = document.getElementById('alamat');
        const statusJemaatSelect = document.getElementById('statusJemaat');
        
        const tabelJemaat = document.getElementById('tabelJemaat');
        const jumlahDataSpan = document.getElementById('jumlahData');
        const updateTerakhirSpan = document.getElementById('updateTerakhir');
        const cariDataInput = document.getElementById('cariData');
        const clearSearchBtn = document.getElementById('clearSearchBtn');

        const tabelJemaatGuest = document.getElementById('tabelJemaatGuest');
        const jumlahDataSpanGuest = document.getElementById('jumlahDataGuest');
        const updateTerakhirSpanGuest = document.getElementById('updateTerakhirGuest');
        const cariDataInputGuest = document.getElementById('cariDataGuest');
        const clearSearchBtnGuest = document.getElementById('clearSearchBtnGuest');

        const btnImport = document.getElementById('btnImport');
        const importFileInput = document.getElementById('importFileInput');
        const btnExport = document.getElementById('btnExport');
        const btnKonfirmasiHapusSemua = document.getElementById('btnKonfirmasiHapusSemua');
        
        const appVersion = 165; 
        let localDataJemaat = []; 
        
        let hapusSemuaModal, notificationModal, confirmDeleteModal, forgotPasswordModal;
        let rowToDeleteId = null;
        let unsubscribe;

        // --- FUNGSI INTI ---
        function showNotification(message) {
            const modalBody = document.getElementById('notificationModalBody');
            modalBody.textContent = message;
            notificationModal.show();
        }

        function initializeModals() {
            hapusSemuaModal = new bootstrap.Modal(document.getElementById('hapusSemuaModal'));
            notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
            confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            forgotPasswordModal = new bootstrap.Modal(document.getElementById('forgotPasswordModal'));
        }

        function renderTable(data) {
            const sortedData = [...data].sort((a, b) => parseInt(a.no, 10) - parseInt(b.no, 10));
            tabelJemaat.innerHTML = '';
            if (sortedData.length === 0) {
                tabelJemaat.innerHTML = '<tr><td colspan="11" class="text-center">Tidak ada data.</td></tr>';
                return;
            }
            sortedData.forEach(jemaat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${jemaat.no}</td><td>${jemaat.noBaptis || '-'}</td><td>${formatDate(jemaat.tglBaptis)}</td>
                    <td>${jemaat.nama || '-'}</td><td>${jemaat.jenisKelamin || 'Pria'}</td><td>${jemaat.tempatLahir || '-'}</td>
                    <td>${formatDate(jemaat.tglLahir)}</td><td>${jemaat.noTelepon || '-'}</td><td>${jemaat.alamat}</td>
                    <td>${jemaat.statusJemaat || 'Aktif'}</td>
                    <td>
                        <button class="btn btn-info btn-sm btn-view" data-id="${jemaat.id}" title="Lihat Data"><i class="bi bi-eye-fill"></i></button>
                        <button class="btn btn-warning btn-sm btn-edit" data-id="${jemaat.id}" title="Edit Data"><i class="bi bi-pencil-square"></i></button>
                        <button class="btn btn-danger btn-sm btn-delete" data-id="${jemaat.id}" title="Hapus Data"><i class="bi bi-trash"></i></button>
                    </td>`;
                tabelJemaat.appendChild(tr);
            });
        }

        function renderTableGuest(data) {
            const sortedData = [...data].sort((a, b) => parseInt(a.no, 10) - parseInt(b.no, 10));
            tabelJemaatGuest.innerHTML = '';
            if (sortedData.length === 0) {
                tabelJemaatGuest.innerHTML = '<tr><td colspan="10" class="text-center">Tidak ada data.</td></tr>';
                return;
            }
            sortedData.forEach(jemaat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${jemaat.no}</td><td>${jemaat.noBaptis || '-'}</td><td>${formatDate(jemaat.tglBaptis)}</td>
                    <td>${jemaat.nama || '-'}</td><td>${jemaat.jenisKelamin || 'Pria'}</td><td>${jemaat.tempatLahir || '-'}</td>
                    <td>${formatDate(jemaat.tglLahir)}</td><td>${jemaat.noTelepon || '-'}</td><td>${jemaat.alamat}</td>
                    <td>${jemaat.statusJemaat || 'Aktif'}</td>`;
                tabelJemaatGuest.appendChild(tr);
            });
        }

        function updateInfo(isGuest = false) {
            const versionString = `Versi ${Math.floor(appVersion / 100)}.${(appVersion % 100).toString().padStart(2, '0')}`;
            document.getElementById('appVersionLogin').textContent = versionString;
            document.getElementById('appVersionMain').textContent = versionString;
            document.getElementById('appVersionGuest').textContent = versionString;
            
            if (isGuest) {
                jumlahDataSpanGuest.textContent = localDataJemaat.length;
            } else {
                jumlahDataSpan.textContent = localDataJemaat.length;
            }
        }

        function updateFormState(mode, jemaat = null) {
            formJemaat.reset();
            editIdInput.value = '';
            formFieldset.disabled = false;
            switch(mode) {
                case 'view':
                    formTitle.innerHTML = '<i class="bi bi-person-lines-fill btn-icon"></i>Lihat Data Jemaat';
                    formFieldset.disabled = true;
                    if (jemaat) populateForm(jemaat);
                    formButtons.innerHTML = `<button type="button" class="btn btn-primary btn-sm" id="btnEditFromView"><i class="bi bi-pencil-square btn-icon"></i>Edit</button><button type="button" class="btn btn-secondary btn-sm" id="btnOKFromView"><i class="bi bi-check-lg btn-icon"></i>OK</button>`;
                    document.getElementById('btnEditFromView').addEventListener('click', () => updateFormState('edit', jemaat));
                    document.getElementById('btnOKFromView').addEventListener('click', () => updateFormState('add'));
                    break;
                case 'edit':
                    formTitle.innerHTML = '<i class="bi bi-pencil-fill btn-icon"></i>Edit Data Jemaat';
                    if (jemaat) populateForm(jemaat);
                    formButtons.innerHTML = `<button type="button" class="btn btn-warning btn-sm" id="btnCancelEdit"><i class="bi bi-x-circle btn-icon"></i>Batal</button><button type="submit" class="btn btn-success btn-sm"><i class="bi bi-check-square btn-icon"></i>Update Data</button>`;
                    document.getElementById('btnCancelEdit').addEventListener('click', () => updateFormState('add'));
                    break;
                case 'add':
                default:
                    formTitle.innerHTML = '<i class="bi bi-person-plus-fill btn-icon"></i>Tambah Data Jemaat';
                    formButtons.innerHTML = `<button type="button" class="btn btn-secondary btn-sm" id="btnResetForm"><i class="bi bi-x-lg btn-icon"></i>Hapus Form</button><button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-save btn-icon"></i>Simpan Data</button>`;
                    document.getElementById('btnResetForm').addEventListener('click', () => formJemaat.reset());
                    break;
            }
        }
        
        function populateForm(jemaat) {
            editIdInput.value = jemaat.id;
            noJemaatInput.value = jemaat.no;
            noBaptisInput.value = jemaat.noBaptis;
            namaInput.value = jemaat.nama;
            if (jemaat.jenisKelamin) document.querySelector(`input[name="jenisKelamin"][value="${jemaat.jenisKelamin}"]`).checked = true;
            else document.getElementById('kelaminPria').checked = true;
            tempatLahirInput.value = jemaat.tempatLahir;
            tglLahirInput.value = jemaat.tglLahir;
            tglBaptisInput.value = jemaat.tglBaptis;
            noTeleponInput.value = jemaat.noTelepon;
            alamatInput.value = jemaat.alamat;
            statusJemaatSelect.value = jemaat.statusJemaat || 'Aktif';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
        }

        // --- EVENT LISTENERS ---
        formJemaat.addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = editIdInput.value;
            const noJemaat = noJemaatInput.value.trim();
            const nama = namaInput.value.trim();
            const alamat = alamatInput.value.trim();
            const errors = [];
            if (!noJemaat) errors.push('No Jemaat');
            if (!nama) errors.push('Nama');
            if (!alamat) errors.push('Alamat Lengkap');
            if (errors.length > 0) {
                showNotification(`Data berikut wajib diisi: ${errors.join(', ')}.`);
                return;
            }
            if (localDataJemaat.some(j => j.no === noJemaat && j.id !== id)) {
                showNotification('No Jemaat sudah ada. Silakan gunakan nomor lain.');
                return;
            }
            const dataBaru = {
                no: noJemaat, noBaptis: noBaptisInput.value.trim(), nama: nama,
                jenisKelamin: document.querySelector('input[name="jenisKelamin"]:checked').value,
                tempatLahir: tempatLahirInput.value.trim(), tglLahir: tglLahirInput.value,
                tglBaptis: tglBaptisInput.value, noTelepon: noTeleponInput.value.trim(),
                alamat: alamat, statusJemaat: statusJemaatSelect.value, timestamp: serverTimestamp()
            };
            try {
                if (id) await setDoc(doc(db, "jemaat", id), dataBaru, { merge: true });
                else await addDoc(jemaatCollectionRef, dataBaru);
                updateFormState('add');
            } catch (error) {
                showNotification("Gagal menyimpan data ke database.");
            }
        });

        tabelJemaat.addEventListener('click', function(e) {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            const jemaat = localDataJemaat.find(j => j.id === id);
            if (target.classList.contains('btn-view')) if (jemaat) { updateFormState('view', jemaat); window.scrollTo({ top: 0, behavior: 'smooth' }); }
            if (target.classList.contains('btn-edit')) if (jemaat) { updateFormState('edit', jemaat); window.scrollTo({ top: 0, behavior: 'smooth' }); }
            if (target.classList.contains('btn-delete')) { rowToDeleteId = id; confirmDeleteModal.show(); }
        });

        document.getElementById('btnKonfirmasiHapusBaris').addEventListener('click', async function() {
            if (rowToDeleteId) {
                try {
                    await deleteDoc(doc(db, "jemaat", rowToDeleteId));
                    updateFormState('add');
                    rowToDeleteId = null;
                } catch (error) { showNotification("Gagal menghapus data."); }
            }
            confirmDeleteModal.hide();
        });

        const setupSearch = (inputEl, clearBtnEl, tableRenderer) => {
            inputEl.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                clearBtnEl.style.display = searchTerm.length > 0 ? 'block' : 'none';
                const filteredData = localDataJemaat.filter(j => 
                    Object.values(j).some(val => val.toString().toLowerCase().includes(searchTerm))
                );
                tableRenderer(filteredData);
            });
            clearBtnEl.addEventListener('click', function() {
                inputEl.value = '';
                inputEl.dispatchEvent(new Event('input'));
                inputEl.focus();
            });
        };
        setupSearch(cariDataInput, clearSearchBtn, renderTable);
        setupSearch(cariDataInputGuest, clearSearchBtnGuest, renderTableGuest);

        btnKonfirmasiHapusSemua.addEventListener('click', async function() {
            try {
                const querySnapshot = await getDocs(jemaatCollectionRef);
                const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                updateFormState('add');
            } catch (error) { showNotification("Gagal menghapus semua data."); }
            hapusSemuaModal.hide();
        });

        btnExport.addEventListener('click', function() {
            try {
                if (localDataJemaat.length === 0) { showNotification('Tidak ada data untuk diekspor.'); return; }
                const headers = ['No Jemaat', 'No Baptis', 'Tgl Baptis', 'Nama', 'Jenis Kelamin', 'Tempat Lahir', 'Tgl Lahir', 'No Telepon', 'Alamat', 'Status Jemaat'];
                let tsvContent = headers.join('\t') + '\n';
                localDataJemaat.forEach(jemaat => {
                    const row = [
                        jemaat.no || '', jemaat.noBaptis || '', jemaat.tglBaptis || '', jemaat.nama || '',
                        jemaat.jenisKelamin || '', jemaat.tempatLahir || '', jemaat.tglLahir || '',
                        jemaat.noTelepon || '', (jemaat.alamat || '').replace(/\n/g, ' '), jemaat.statusJemaat || ''
                    ];
                    tsvContent += row.join('\t') + '\n';
                });
                const blob = new Blob([tsvContent], { type: 'text/tab-separated-values;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "Data-Jemaat-GSRI-Skw.tsv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) { showNotification('Gagal mengekspor file.'); }
        });
        
        btnImport.addEventListener('click', () => importFileInput.click());

        importFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                const lines = content.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { showNotification('File kosong atau hanya berisi header.'); return; }
                const importedData = [];
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split('\t');
                    const noJemaat = cols[0] ? cols[0].trim() : '';
                    if (noJemaat && !localDataJemaat.some(j => j.no === noJemaat)) {
                        importedData.push({
                            no: noJemaat, noBaptis: cols[1] || '', tglBaptis: cols[2] || '', nama: cols[3] || '',
                            jenisKelamin: cols[4] || 'Pria', tempatLahir: cols[5] || '', tglLahir: cols[6] || '',
                            noTelepon: cols[7] || '', alamat: cols[8] || '', statusJemaat: cols[9] || 'Aktif',
                            timestamp: serverTimestamp()
                        });
                    }
                }
                if (importedData.length > 0) {
                    importedData.forEach(async (jemaat) => {
                        try { await addDoc(jemaatCollectionRef, jemaat); } catch (error) { console.error(error); }
                    });
                    showNotification(`${importedData.length} data baru berhasil diimpor.`);
                } else {
                    showNotification('Tidak ada data baru yang diimpor.');
                }
                importFileInput.value = '';
            };
            reader.onerror = () => showNotification('Gagal membaca file.');
            reader.readAsText(file);
        });

        // --- AUTHENTICATION LOGIC ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await setPersistence(auth, browserSessionPersistence);
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                    showNotification('Login gagal: Periksa kembali email dan password Anda!');
                } else {
                    showNotification(`Gagal login: ${error.message}`);
                }
            }
        });

        guestLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pinInput = document.getElementById('guestPin').value;
            try {
                const pinDocRef = doc(db, "pin", "tamu");
                const pinDoc = await getDoc(pinDocRef);
                if (pinDoc.exists() && pinDoc.data().pin === pinInput) {
                    await setPersistence(auth, browserSessionPersistence);
                    await signInAnonymously(auth);
                } else {
                    showNotification("PIN salah.");
                }
            } catch (error) {
                console.error("Guest login error: ", error);
                showNotification(`Gagal login sebagai tamu. Error: ${error.code}`);
            }
        });

        const handleLogout = async () => {
            try { await signOut(auth); } catch (error) { showNotification(`Logout gagal: ${error.message}`); }
        };
        logoutBtnAdmin.addEventListener('click', handleLogout);
        logoutBtnGuest.addEventListener('click', handleLogout);

        sendResetEmailBtn.addEventListener('click', async () => {
            const email = document.getElementById('resetEmailInput').value;
            if (!email) { showNotification('Silakan masukkan alamat email Anda.'); return; }
            try {
                await sendPasswordResetEmail(auth, email);
                forgotPasswordModal.hide();
                showNotification('Email reset password telah dikirim. Silakan cek inbox Anda.');
            } catch (error) { showNotification(`Gagal mengirim email: ${error.message}`); }
        });

        // --- INISIALISASI APLIKASI & FIREBASE LISTENER ---
        function initializeAppLogic(isGuest = false) {
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(jemaatCollectionRef, (snapshot) => {
                localDataJemaat = [];
                let latestTimestamp = null;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    localDataJemaat.push({ ...data, id: doc.id });
                    if (data.timestamp && data.timestamp.toDate) {
                        const docTimestamp = data.timestamp.toDate();
                        if (!latestTimestamp || docTimestamp > latestTimestamp) {
                            latestTimestamp = docTimestamp;
                        }
                    }
                });
                const lastUpdateText = latestTimestamp ? `Update data terakhir: ${latestTimestamp.toLocaleString('id-ID')}` : 'Update data terakhir: -';
                
                if (isGuest) {
                    updateTerakhirSpanGuest.textContent = lastUpdateText;
                    renderTableGuest(localDataJemaat);
                } else {
                    updateTerakhirSpan.textContent = lastUpdateText;
                    renderTable(localDataJemaat);
                }
                updateInfo(isGuest);
            }, (error) => {
                showNotification("Gagal memuat data dari database.");
            });
        }

        initializeModals();
        updateInfo();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginPage.style.display = 'none';
                if (user.isAnonymous) {
                    mainAppAdmin.style.display = 'none';
                    mainAppGuest.style.display = 'block';
                    initializeAppLogic(true);
                } else {
                    mainAppGuest.style.display = 'none';
                    mainAppAdmin.style.display = 'block';
                    initializeAppLogic(false);
                }
            } else {
                if (unsubscribe) unsubscribe();
                loginPage.style.display = 'block';
                mainAppAdmin.style.display = 'none';
                mainAppGuest.style.display = 'none';
                loginForm.reset();
                guestLoginForm.reset();
            }
        });
    </script>

</body>
</html>
